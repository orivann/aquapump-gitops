---
# ==============================================================================
# Aquapump GitOps Manifest Validation Workflow
# ----------------------------------------------------------------------------
# Performs YAML linting and Kubernetes schema validation for Argo CD manifests
# to ensure GitOps configuration accuracy prior to synchronization.
# ==============================================================================
name: Aquapump GitOps Validation

'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  yaml_lint:
    name: YAML linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install yamllint
        run: pip install yamllint==1.35.1

      - name: Run yamllint
        run: yamllint .

  manifest_validate:
    name: Kubernetes manifest validation
    runs-on: ubuntu-latest
    needs: yaml_lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kubeconform
        run: |
          KUBECONFORM_URL="https://github.com/yannh/kubeconform/releases/download/v0.6.5/kubeconform-linux-amd64.tar.gz"
          curl -L "$KUBECONFORM_URL" -o kubeconform.tar.gz
          tar -xf kubeconform.tar.gz kubeconform
          sudo mv kubeconform /usr/local/bin/
          rm kubeconform.tar.gz

      - name: Create ephemeral kubeconfig
        run: |
          cat <<'KUBECONFIG' > kubeconfig
          apiVersion: v1
          kind: Config
          clusters:
            - cluster:
                server: https://127.0.0.1
              name: placeholder
          contexts:
            - context:
                cluster: placeholder
                user: placeholder
              name: placeholder
          current-context: placeholder
          preferences: {}
          users:
            - name: placeholder
              user:
                token: placeholder
          KUBECONFIG
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"

      - name: Dry-run apply manifests with kubectl
        run: |
          # Skip contacting a real API server; kubeconform handles schema checks
          find . -name '*.yaml' -o -name '*.yml' | while read -r file; do
            kubectl apply --dry-run=client --validate=false -f "$file"
          done

      - name: Validate manifests with kubeconform
        run: |
          find . -name '*.yaml' -o -name '*.yml' -print0 | \
            xargs -0 kubeconform -strict -summary -ignore-missing-schemas
